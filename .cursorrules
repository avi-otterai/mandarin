# Mandarin - Chinese Learning App

## Project Context
React/TypeScript webapp for learning Mandarin Chinese using spaced repetition (SRS).
See README.md for full feature list, setup, tech stack, data model, and schema documentation.

## Repository
- **GitHub**: https://github.com/avi-otterai/mandarin.git
- **Remote**: `origin` using `github.com-avi` SSH alias (personal key)

---

## ⛔ CRITICAL: DATABASE MIGRATION SAFETY

**On Feb 2 2026, a careless schema migration DELETED HUNDREDS OF USER QUIZ ATTEMPTS.**

The migration renamed `concept_id` to `vocabulary_id` and added a foreign key to a new `vocabulary` table with `ON DELETE CASCADE`. Since the new vocabulary table had different UUIDs, all historical quiz data was orphaned and lost.

### NEVER DO THIS:
- ❌ Add foreign keys to columns with existing data pointing to old UUIDs
- ❌ Use `ON DELETE CASCADE` without understanding the data relationships
- ❌ Drop/recreate tables that have user data without migration scripts
- ❌ Assume schema changes are safe without checking existing data

### ALWAYS DO THIS:
- ✅ **BACK UP production data** before ANY schema migration
- ✅ Create mapping tables when changing ID references
- ✅ Test migrations on a copy of production data first
- ✅ Use `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` for additive changes only
- ✅ Ask user to confirm before running any migration that touches existing tables with data

**If you need to change quiz_attempts, user_progress, or any table with user data:**
1. Show the user the EXACT SQL you plan to run
2. Explain what data could be affected
3. Wait for explicit approval
4. Consider using Supabase branching for testing

---

## ⚠️ CRITICAL: Known vs Unknown Words

**This is the most important concept in the app - understand this before making any changes!**

### Binary Categories (ONLY 2)
| Status | Checkbox | Understanding | In Revise? |
|--------|----------|---------------|------------|
| **Known** | ✓ Checked | spectrum | **YES** |
| **Unknown** | ☐ Unchecked | spectrum | **NO** |

### Why Vocab-led Design
- **Avoids overwhelm**: User only sees words they've explicitly selected
- **Controlled learning**: Start with a few checked words, expand gradually
- **Intentional vocabulary**: Revise tab is never cluttered with unselected words

---

## Task Workflow (ALWAYS FOLLOW)

When working on any new task/feature:
After completion of a feature/fix, you must automatically update README (but after testing).
Then you must attempt to commit, merge, push, again without the user having to say it.

### 1. Understand First
- [ ] Read `README.md` for project overview, data model, and schema
- [ ] Read `.cursorrules` for conventions and warnings
- [ ] Understand current code structure before making changes

### 2. Plan Before Implementing
- [ ] Outline the approach/changes needed
- [ ] **If touching database schema: STOP and get explicit approval**
- [ ] Confirm plan with user if it's a large change

### 3. Implement
- [ ] Create a **new feature branch** (never commit directly to main)
- [ ] Make changes following existing code patterns
- [ ] Test locally if applicable

### 4. Document
- [ ] Update `README.md` if adding features or changing behavior
- [ ] Add comments for complex logic

### 5. Test Before Push
- [ ] Run `npm run dev` to test locally
- [ ] Run `npm run build` to verify no TypeScript/build errors
- [ ] Fix any issues before committing

### 6. Commit & Push
- [ ] Check git status, diffs to understand not just your current changes but other simultaneous ones
- [ ] Commit with a descriptive message for all changes
- [ ] Push to origin (default behavior unless user says otherwise)

```bash
git checkout main
git merge feature/your-feature-name
git push origin main
```

---

## Git Workflow

### Branch Strategy
- **main**: Single branch for all development.

### Committing
If GPG signing fails, use:
```bash
git commit --no-gpg-sign -m "your message"
```

### Pushing to GitHub
This repo uses the `github.com-avi` SSH alias (personal key, not work key):
```bash
git push -u origin feature/your-feature-name
```

**Important for Cursor terminal**: Always use `required_permissions: ["all"]` when pushing to access SSH keys.

### Merging to Main
1. Make changes
2. Merge locally
3. After server testing, push
```bash
git add .
git status
git commit -m "long message"
git push origin main
```
Note that there may be simultaneous edits by other cursor agents, so git status (and maybe diff) will help you understand what full commit is about.

### SSH Configuration
The repo uses `github.com-avi` alias which maps to personal SSH key (`~/.ssh/id_ed25519`), not the work Teleport certificate.
